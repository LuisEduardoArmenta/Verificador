<div class="d-flex">
  <app-admin-sidebar></app-admin-sidebar>
  
  <div class="main-content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Gestión de Horarios</h4>
          <button class="btn btn-primary" (click)="limpiarFormulario(); mostrarModal = true;">
            <i class="fas fa-plus"></i> Nuevo Horario
          </button>
        </div>
        
        <div class="card-body">
          <!-- Navegación -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group">
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'horarios'" (click)="cambiarSeccion('horarios')">
                    Horarios
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'edificios'" (click)="cambiarSeccion('edificios')">
                    Edificios
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'aulas'" (click)="cambiarSeccion('aulas')">
                    Aulas
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'carreras'" (click)="cambiarSeccion('carreras')">
                    Carreras
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'grupos'" (click)="cambiarSeccion('grupos')">
                    Grupos
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'materias'" (click)="cambiarSeccion('materias')">
                    Materias
                  </button>
                  <button class="btn btn-outline-primary" [class.active]="seccionActual === 'profesores'" (click)="cambiarSeccion('profesores')">
                    Profesores
                  </button>
                </div>
                <button class="btn btn-primary" (click)="abrirModal('crear')">
                  Nuevo {{getTituloSeccion()}}
                </button>
              </div>
            </div>
          </div>

          <!-- Contenido -->
          <div class="content-container">
            <!-- Tabla Profesores -->
            <div class="card" *ngIf="seccionActual === 'profesores'">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Email</th>
                        <th>Carrera</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let profesor of profesores">
                        <td>{{profesor.id}}</td>
                        <td>{{profesor.nombre}}</td>
                        <td>{{profesor.apellido}}</td>
                        <td>{{profesor.email}}</td>
                        <td>{{getNombreCarrera(profesor.carrera)}}</td>
                        <td>
                          <span [class]="'badge ' + (profesor.activo ? 'bg-success' : 'bg-danger')">
                            {{profesor.activo ? 'Activo' : 'Inactivo'}}
                          </span>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-primary me-1" (click)="abrirModal('editar', profesor)">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-danger" (click)="eliminarProfesor(profesor.id!)">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Tablas -->
            <div class="table-responsive">
              <!-- Tabla Edificios -->
              <table *ngIf="seccionActual === 'edificios'" class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let edificio of edificios">
                    <td>{{edificio.id}}</td>
                    <td>{{edificio.nombre}}</td>
                    <td>{{edificio.descripcion}}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2" (click)="editar(edificio)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="eliminar('edificios', edificio.id!)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="edificios.length === 0">
                    <td colspan="4" class="text-center">No hay edificios registrados</td>
                  </tr>
                </tbody>
              </table>

              <!-- Tabla Aulas -->
              <table *ngIf="seccionActual === 'aulas'" class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Edificio</th>
                    <th>Capacidad</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let aula of aulas">
                    <td>{{aula.id}}</td>
                    <td>{{aula.nombre}}</td>
                    <td>{{getNombreEdificio(aula.edificio)}}</td>
                    <td>{{aula.capacidad}}</td>
                    <td>{{aula.descripcion}}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2" (click)="editar(aula)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="eliminar('aulas', aula.id!)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="aulas.length === 0">
                    <td colspan="6" class="text-center">No hay aulas registradas</td>
                  </tr>
                </tbody>
              </table>

              <!-- Tabla Carreras -->
              <table *ngIf="seccionActual === 'carreras'" class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let carrera of carreras">
                    <td>{{carrera.id}}</td>
                    <td>{{carrera.codigo}}</td>
                    <td>{{carrera.nombre}}</td>
                    <td>{{carrera.descripcion}}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2" (click)="editar(carrera)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="eliminar('carreras', carrera.id!)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="carreras.length === 0">
                    <td colspan="5" class="text-center">No hay carreras registradas</td>
                  </tr>
                </tbody>
              </table>

              <!-- Tabla Grupos -->
              <table *ngIf="seccionActual === 'grupos'" class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Carrera</th>
                    <th>Semestre</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let grupo of grupos">
                    <td>{{grupo.id}}</td>
                    <td>{{grupo.nombre}}</td>
                    <td>{{getNombreCarrera(grupo.carrera)}}</td>
                    <td>{{grupo.semestre}}</td>
                    <td>{{grupo.descripcion}}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2" (click)="editar(grupo)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="eliminar('grupos', grupo.id!)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="grupos.length === 0">
                    <td colspan="6" class="text-center">No hay grupos registrados</td>
                  </tr>
                </tbody>
              </table>

              <!-- Tabla Materias -->
              <table *ngIf="seccionActual === 'materias'" class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let materia of materias">
                    <td>{{materia.id}}</td>
                    <td>{{materia.codigo}}</td>
                    <td>{{materia.nombre}}</td>
                    <td>{{materia.descripcion}}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2" (click)="editar(materia)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="eliminar('materias', materia.id!)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="materias.length === 0">
                    <td colspan="5" class="text-center">No hay materias registradas</td>
                  </tr>
                </tbody>
              </table>

              <!-- Tabla Horarios -->
              <div class="card" *ngIf="seccionActual === 'horarios'">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-horarios">
                      <thead>
                        <tr>
                          <th>Grupo</th>
                          <th>Carrera</th>
                          <th>Edificio</th>
                          <th>Aula</th>
                          <th>Estado</th>
                          <th>Verificador</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let horario of horariosGrupo">
                          <td>{{getNombreGrupo(horario.grupo)}}</td>
                          <td>{{getNombreCarrera(horario.carrera)}}</td>
                          <td>{{getNombreEdificio(horario.edificio)}}</td>
                          <td>{{getNombreAula(horario.aula)}}</td>
                          <td>
                            <span [class]="'badge ' + 
                              (horario.estado === 'verificado' ? 'badge-verificado' : 
                               horario.estado === 'asignado' ? 'badge-asignado' : 'badge-pendiente')">
                              {{horario.estado}}
                            </span>
                          </td>
                          <td>
                            <select class="verificador-select" #verificadorSelect (change)="asignarVerificador(horario.id!, verificadorSelect.value)">
                              <option value="">Seleccionar verificador</option>
                              <option *ngFor="let verificador of verificadoresDisponibles" [value]="verificador.id" [selected]="verificador.id === horario.verificador">
                                {{verificador.nombre}}
                              </option>
                            </select>
                          </td>
                          <td>
                            <button class="btn btn-action btn-info" (click)="verDetallesHorario(horario)" title="Ver detalles">
                              <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-action btn-primary" (click)="editarHorario(horario)" title="Editar horario">
                              <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-action btn-danger" (click)="eliminarHorario(horario.id!)" title="Eliminar horario">
                              <i class="fas fa-trash"></i> Eliminar
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar -->
<div class="modal fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} {{getTituloSeccion()}}</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Formulario de Horarios -->
        <form [formGroup]="horarioForm" *ngIf="seccionActual === 'horarios'">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-group">
                <label>Grupo</label>
                <select class="form-select" formControlName="grupo" required>
                  <option [ngValue]="0">Seleccione un grupo</option>
                  <option *ngFor="let grupo of grupos" [value]="grupo.id">
                    {{ grupo.nombre }}
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Carrera</label>
                <select class="form-select" formControlName="carrera" required>
                  <option [ngValue]="0">Seleccione una carrera</option>
                  <option *ngFor="let carrera of carreras" [value]="carrera.id">
                    {{ carrera.nombre }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-group">
                <label>Edificio</label>
                <select class="form-select" formControlName="edificio" required>
                  <option [ngValue]="0">Seleccione un edificio</option>
                  <option *ngFor="let edificio of edificios" [value]="edificio.id">
                    {{ edificio.nombre }}
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Aula</label>
                <select class="form-select" formControlName="aula" required>
                  <option [ngValue]="0">Seleccione un aula</option>
                  <option *ngFor="let aula of aulas" [value]="aula.id">
                    {{ aula.nombre }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-horario">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th *ngFor="let dia of diasSemana">{{ dia }}</th>
                  <th>
                    <button type="button" class="btn btn-success btn-sm" (click)="agregarHora()">
                      <i class="fas fa-plus"></i>
                    </button>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let hora of horas; let i = index">
                  <td>
                    {{ hora }}
                    <button *ngIf="i > 0" type="button" class="btn btn-danger btn-sm ms-2" (click)="eliminarHora(i)">
                      <i class="fas fa-minus"></i>
                    </button>
                  </td>
                  <td *ngFor="let dia of diasSemana">
                    <ng-container *ngTemplateOutlet="celdaHorario; context: { $implicit: obtenerDetalleHorario(hora, dia), dia: dia, hora: hora }">
                    </ng-container>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </form>

        <!-- Formulario de Edificios -->
        <form [formGroup]="edificioForm" *ngIf="seccionActual === 'edificios'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
            <div class="col-md-6">
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" formControlName="descripcion">
            </div>
          </div>
        </form>

        <!-- Formulario de Aulas -->
        <form [formGroup]="aulaForm" *ngIf="seccionActual === 'aulas'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
            <div class="col-md-6">
              <label class="form-label">Capacidad</label>
              <input type="number" class="form-control" formControlName="capacidad">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Edificio</label>
              <select class="form-select" formControlName="edificio">
                <option value="">Seleccionar edificio</option>
                <option *ngFor="let edificio of edificios" [value]="edificio.id">
                  {{edificio.nombre}}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" formControlName="descripcion">
            </div>
          </div>
        </form>

        <!-- Formulario de Carreras -->
        <form [formGroup]="carreraForm" *ngIf="seccionActual === 'carreras'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Código</label>
              <input type="text" class="form-control" formControlName="codigo">
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" formControlName="descripcion">
            </div>
          </div>
        </form>

        <!-- Formulario de Grupos -->
        <form [formGroup]="grupoForm" *ngIf="seccionActual === 'grupos'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
            <div class="col-md-6">
              <label class="form-label">Semestre</label>
              <input type="number" class="form-control" formControlName="semestre">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Carrera</label>
              <select class="form-select" formControlName="carrera">
                <option value="">Seleccionar carrera</option>
                <option *ngFor="let carrera of carreras" [value]="carrera.id">
                  {{carrera.nombre}}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" formControlName="descripcion">
            </div>
          </div>
        </form>

        <!-- Formulario de Materias -->
        <form [formGroup]="materiaForm" *ngIf="seccionActual === 'materias'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Código</label>
              <input type="text" class="form-control" formControlName="codigo">
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" formControlName="descripcion">
            </div>
          </div>
        </form>

        <!-- Formulario de Profesores -->
        <form [formGroup]="profesorForm" *ngIf="seccionActual === 'profesores'">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido</label>
              <input type="text" class="form-control" formControlName="apellido">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" formControlName="email">
            </div>
            <div class="col-md-6">
              <label class="form-label">Carrera</label>
              <select class="form-select" formControlName="carrera" required>
                <option [ngValue]="0">Seleccione una carrera</option>
                <option *ngFor="let carrera of carreras" [value]="carrera.id">
                  {{carrera.nombre}}
                </option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="guardar()">
          {{modoEdicion ? 'Actualizar' : 'Guardar'}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Template para celda de horario -->
<ng-template #celdaHorario let-detalle let-dia="dia" let-hora="hora">
  <div *ngIf="detalle; else agregarBtn" class="horario-cell">
    <select class="form-select form-select-sm mb-1" [(ngModel)]="detalle.materia" [name]="'materia_' + dia + hora">
      <option [ngValue]="0">Seleccione materia</option>
      <option *ngFor="let materia of materias" [value]="materia.id">
        {{ materia.nombre }}
      </option>
    </select>
    <select class="form-select form-select-sm mb-1" 
            [(ngModel)]="detalle.profesor" 
            [name]="'profesor_' + dia + hora">
      <option [ngValue]="0">Seleccione profesor</option>
      <option *ngFor="let profesor of profesores" 
              [value]="profesor.id">
        {{ profesor.nombre }} {{ profesor.apellido }}
      </option>
    </select>
    <button type="button" class="btn btn-danger btn-sm" 
            (click)="eliminarDetalle(horarioForm.get('detalles')?.value?.indexOf(detalle) || 0)">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <ng-template #agregarBtn>
    <button type="button" class="btn btn-outline-primary btn-sm" 
            (click)="agregarDetalle(dia, hora)">
      <i class="fas fa-plus"></i>
    </button>
  </ng-template>
</ng-template>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="mostrarModal"></div>

<!-- Modal de Detalles del Horario -->
<div class="modal fade modal-detalles" id="detallesHorarioModal" tabindex="-1" [class.show]="mostrarModalDetalles" [style.display]="mostrarModalDetalles ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalles del Horario</h5>
        <button type="button" class="btn-close" (click)="cerrarModalDetalles()"></button>
      </div>
      <div class="modal-body" *ngIf="horarioSeleccionado">
        <!-- Información del Verificador -->
        <div class="verificador-info">
          <div>
            <h6 class="mb-1">Verificador Asignado</h6>
            <p class="mb-0">{{obtenerNombreVerificador(horarioSeleccionado.verificador) || 'No asignado'}}</p>
          </div>
          <button class="btn btn-export" (click)="exportarPDF(horarioSeleccionado)">
            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <p><strong>Grupo:</strong> {{obtenerNombreGrupo(horarioSeleccionado.grupo)}}</p>
            <p><strong>Carrera:</strong> {{obtenerNombreCarrera(horarioSeleccionado.carrera)}}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Edificio:</strong> {{obtenerNombreEdificio(horarioSeleccionado.edificio)}}</p>
            <p><strong>Aula:</strong> {{obtenerNombreAula(horarioSeleccionado.aula)}}</p>
          </div>
        </div>

        <h6 class="mb-3">Horario Semanal</h6>
        <div class="table-responsive">
          <table class="table table-horarios">
            <thead>
              <tr>
                <th>Hora</th>
                <th *ngFor="let dia of diasSemana">{{ dia }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let hora of horas">
                <td>{{ hora }}</td>
                <td *ngFor="let dia of diasSemana">
                  <div *ngIf="obtenerDetalleHorarioSeleccionado(hora, dia) as detalle">
                    <div *ngIf="detalle.materia" class="horario-detalle">
                      <strong>Materia:</strong> {{ obtenerNombreMateria(detalle.materia) }}<br>
                      <strong>Profesor:</strong> {{ getNombreProfesor(detalle.profesor) }}
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalDetalles()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
